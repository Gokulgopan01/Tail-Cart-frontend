<div class="shop-wrapper">
  <!-- Lottie Banner Container -->
  <div class="auth-lottie-container shop-banner">
    <h2 class="cart-heading">Luxury Collections</h2>
    <div #shopBannerLottie class="banner-lottie"></div>
  </div>

  <!-- Admin Controls -->
  <div class="admin-top-bar" *ngIf="isAdmin()">
    <div class="container">
      <div class="admin-info">
        <i class="fas fa-shield-alt"></i>
        <span>Admin Dashboard</span>
      </div>
      <button class="btn-add-product" (click)="openAddProductModal()">
        <i class="fas fa-plus"></i> Add New Product
      </button>
    </div>
  </div>

  <div class="shop-content container">
    <!-- Header Section -->
    <header class="shop-header">
      <div class="items-found-text">
        {{filteredProducts.length}} Premium items found
      </div>

      <!-- Toolbar -->
      <div class="shop-toolbar glass-effect">
        <!-- Search -->
        <div class="toolbar-search">
          <i class="fas fa-search search-icon"></i>
          <input type="text" placeholder="Search products..." [(ngModel)]="searchQuery" (input)="updateSearch()"
            class="search-input">
        </div>

        <!-- Filters & Sort -->
        <div class="toolbar-actions">
          <div class="select-group">
            <i class="fas fa-filter icon-label"></i>
            <select (change)="onPetFilterChange($event)" class="toolbar-select">
              <option value="all">All Pets</option>
              <option value="Dog">Dogs</option>
              <option value="Cat">Cats</option>
            </select>
          </div>

          <div class="select-group">
            <i class="fas fa-sort-amount-down icon-label"></i>
            <select [(ngModel)]="sortOption" (change)="applySorting()" class="toolbar-select">
              <option value="newest">Newest</option>
              <option value="priceLow">Price: $ to $$$</option>
              <option value="priceHigh">Price: $$$ to $</option>
              <option value="name">Name: A-Z</option>
            </select>
          </div>

          <!-- Layout Toggle -->
          <div class="layout-toggle">
            <button class="toggle-btn" [class.active]="!isGridView" (click)="toggleViewMode(false)" title="List View">
              <i class="fas fa-list"></i>
            </button>
            <button class="toggle-btn" [class.active]="isGridView" (click)="toggleViewMode(true)" title="Grid View">
              <i class="fas fa-th-large"></i>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Product Grid -->
    <main class="products-grid" [class.list-mode]="!isGridView">
      <div class="product-card" *ngFor="let product of paginatedProducts" [class.hot-deal]="product.deals">
        <!-- Card Image Area -->
        <div class="card-image-wrapper" (click)="openQuickView(product)">
          <div class="deal-badge" *ngIf="product.deals">{{product.deals}}</div>
          <img [src]="product.image" [alt]="product.model" class="product-image">

          <div class="card-overlay">
            <button class="quick-view-btn" (click)="openQuickView(product); $event.stopPropagation()">
              <i class="fas fa-eye"></i> Quick View
            </button>
            <div class="admin-actions" *ngIf="isAdmin()">
              <button class="action-btn edit" (click)="openEditProductModal(product); $event.stopPropagation()">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn delete" (click)="deleteProduct(product.id, $event); $event.stopPropagation()">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Card Body -->
        <div class="card-body">
          <div class="breed-tag">{{product.breed}}</div>
          <h3 class="product-model">{{product.model}}</h3>

          <div class="rating-row">
            <div class="stars">
              <span [innerHTML]="generateStars(product.reviews)"></span>
              <span class="rating-val">{{product.reviews}}</span>
            </div>
            <div class="price-val">${{product.price}}</div>
          </div>

          <button class="btn-cart" (click)="onAddToCartClick(product, $event)">
            <i class="fas fa-shopping-bag"></i> <span>Add to Cart</span>
          </button>
        </div>
      </div>
    </main>

    <!-- No Results -->
    <div class="no-results" *ngIf="filteredProducts.length === 0">
      <div class="empty-state">
        <i class="fas fa-box-open"></i>
        <h3>No products found</h3>
        <p>Try adjusting your search or filters.</p>
        <button class="btn-clear" (click)="clearFilters()">Clear Filters</button>
      </div>
    </div>

    <!-- Pagination -->
    <div class="load-more-container" *ngIf="!allProductsLoaded && filteredProducts.length > paginatedProducts.length">
      <button class="btn-load-more" (click)="loadMore()">
        <span>Explore More</span>
        <i class="fas fa-chevron-down"></i>
      </button>
    </div>
  </div>

  <!-- Quick View Modal -->
  <div class="modal-root" *ngIf="showQuickView" (click)="closeQuickView()">
    <div class="modal-card quick-view-box" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeQuickView()">
        <i class="fas fa-times"></i>
      </button>

      <div class="modal-content-grid">
        <div class="modal-img-area">
          <img [src]="selectedProduct?.image" [alt]="selectedProduct?.model">
        </div>
        <div class="modal-details-area">
          <div class="modal-tags">
            <span class="tag-gold">{{selectedProduct?.breed}}</span>
            <span class="tag-dark" *ngIf="selectedProduct?.deals">{{selectedProduct?.deals}}</span>
          </div>
          <h2 class="modal-title">{{selectedProduct?.model}}</h2>
          <div class="modal-rating">
            <span [innerHTML]="generateStars(selectedProduct?.reviews || '0')"></span>
            <span class="rating-count">({{selectedProduct?.reviews}} reviews)</span>
          </div>
          <div class="modal-price">${{selectedProduct?.price}}</div>

          <div class="modal-info">
            <p>{{selectedProduct?.product_info}}</p>
          </div>

          <ul class="modal-perks">
            <li><i class="fas fa-check-circle"></i> Genuine Luxury Item</li>
            <li><i class="fas fa-truck"></i> Fast Global Shipping</li>
          </ul>

          <button class="btn-modal-cart" (click)="onAddToCartClick(selectedProduct!, $event)">
            <i class="fas fa-shopping-bag"></i> Add to Cart
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart Process Modal (Pet/Quantity Selection) -->
  <div class="modal-root" *ngIf="selectedProductForCart && (showPetIdInput || showQuantityInput)"
    (click)="cancelCartProcess()">
    <div class="modal-card small-modal" (click)="$event.stopPropagation()">
      <div class="modal-header-simple">
        <h3>Complete Your Order</h3>
        <button class="btn-icon-close" (click)="cancelCartProcess()"><i class="fas fa-times"></i></button>
      </div>

      <div class="modal-body-simple">
        <!-- Pet Step -->
        <div *ngIf="showPetIdInput" class="step-animation">
          <p class="step-label">Select your pet:</p>
          <select class="custom-input" [(ngModel)]="selectedPetId">
            <option value="" disabled selected>Choose a pet...</option>
            <option *ngFor="let pet of userPets" [value]="pet.pet_id">{{ pet.pet_name }} ({{ pet.breed }})</option>
          </select>
          <div class="step-actions">
            <button class="btn-cancel" (click)="cancelCartProcess()">Cancel</button>
            <button class="btn-next" (click)="submitPetSelection()">Next</button>
          </div>
        </div>

        <!-- Quantity Step -->
        <div *ngIf="showQuantityInput" class="step-animation">
          <p class="step-label">Select quantity:</p>
          <div class="qty-control">
            <button class="qty-btn" (click)="decrementQuantity()">-</button>
            <span class="qty-num">{{ quantity }}</span>
            <button class="qty-btn" (click)="incrementQuantity()">+</button>
          </div>
          <div class="total-row">
            <span>Subtotal:</span>
            <strong>${{ (selectedProductForCart.price * quantity).toFixed(2) }}</strong>
          </div>
          <div class="step-actions">
            <button class="btn-back" (click)="showPetIdInput = true; showQuantityInput = false">Back</button>
            <button class="btn-confirm" (click)="submitQuantity()">Confirm Add</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Add/Edit Modal -->
  <div class="modal-root" *ngIf="showAddProductModal" (click)="closeAddProductModal()">
    <div class="modal-card form-modal" (click)="$event.stopPropagation()">
      <div class="modal-header-simple">
        <h3>{{ editingProduct ? 'Edit Product' : 'Add New Product' }}</h3>
        <button class="btn-icon-close" (click)="closeAddProductModal()"><i class="fas fa-times"></i></button>
      </div>

      <div class="modal-body-scroll">
        <form (ngSubmit)="saveProduct()" #productForm="ngForm" class="luxury-form">
          <div class="form-grid">
            <div class="field">
              <label>Model Name</label>
              <input type="text" [(ngModel)]="newProduct.model" name="model" required class="luxury-input">
            </div>
            <div class="field">
              <label>Price ($)</label>
              <input type="number" [(ngModel)]="newProduct.price" name="price" required class="luxury-input">
            </div>
            <div class="field">
              <label>Pet Type</label>
              <select [(ngModel)]="newProduct.breed" name="breed" required class="luxury-input">
                <option value="Dog">Dog</option>
                <option value="Cat">Cat</option>
              </select>
            </div>
            <div class="field">
              <label>Stock</label>
              <input type="number" [(ngModel)]="newProduct.quantity" name="quantity" required class="luxury-input">
            </div>
            <div class="field full">
              <label>Description</label>
              <textarea [(ngModel)]="newProduct.product_info" name="product_info" required rows="3"
                class="luxury-input"></textarea>
            </div>
            <div class="field">
              <label>Rating (1-5)</label>
              <input type="number" [(ngModel)]="newProduct.reviews" name="reviews" step="0.1" class="luxury-input">
            </div>
            <div class="field">
              <label>Deal Tag</label>
              <select [(ngModel)]="newProduct.deals" name="deals" class="luxury-input">
                <option value="">None</option>
                <option value="Hot Sale">Hot Sale</option>
                <option value="Bestseller">Bestseller</option>
              </select>
            </div>
            <div class="field full">
              <label>Product Image</label>
              <div class="upload-zone" (click)="triggerFileInput()" [class.has-file]="newProduct.image">
                <i class="fas fa-upload"></i>
                <span>{{ newProduct.image ? newProduct.image.name : 'Click to upload image' }}</span>
                <input type="file" #fileInput (change)="onFileSelected($event)" hidden accept="image/*">
              </div>
            </div>
          </div>
          <div class="form-footer">
            <button type="button" class="btn-cancel" (click)="closeAddProductModal()">Cancel</button>
            <button type="submit" class="btn-submit" [disabled]="!productForm.valid || isCreatingProduct">
              {{ editingProduct ? 'Save Changes' : 'Create Product' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Confirm Modal -->
  <div class="modal-root" *ngIf="showDeleteModal" (click)="closeDeleteModal()">
    <div class="modal-card small-modal confirm-delete" (click)="$event.stopPropagation()">
      <div class="confirm-content">
        <div class="warn-icon"><i class="fas fa-exclamation-triangle"></i></div>
        <h3>Delete Product?</h3>
        <p>This action cannot be undone.</p>
        <div class="confirm-actions">
          <button class="btn-light" (click)="closeDeleteModal()">Cancel</button>
          <button class="btn-danger" (click)="confirmDelete()" [disabled]="isDeleting">
            {{ isDeleting ? 'Deleting...' : 'Confirm Delete' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>