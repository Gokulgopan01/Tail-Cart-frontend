<div class="profile-page">
  <!-- Premium Header -->
  <header class="profile-hero glass-effect">
    <div class="container hero-content">
      <div class="hero-text">
        <h1 class="hero-title">My Pet Family</h1>
        <p class="hero-subtitle">Manage your profile and furry friends in your personal vault</p>
      </div>

      <!-- Luxury Tab Switcher -->
      <div class="tabs-container">
        <div class="tabs-pill">
          <button class="tab-btn" [class.active]="activeTab === 'owner'" (click)="switchTab('owner')">
            <i class="fas fa-user-circle"></i> Owner Profile
          </button>
          <button class="tab-btn" [class.active]="activeTab === 'pets'" (click)="switchTab('pets')">
            <i class="fas fa-paw"></i> My Pets
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="container main-content">

    <!-- Owner Profile Tab -->
    <section class="tab-section" *ngIf="activeTab === 'owner'" [@tabAnimation]>
      <div class="owner-profile-card luxury-card">
        <div class="card-pattern"></div>

        <div class="owner-hero">
          <div class="owner-photo-wrapper pulse-border">
            <img [src]="getOwnerPhotoUrl()" alt="Owner" class="owner-photo" (error)="handleOwnerImageError($event)">
            <div class="edit-badge" (click)="toggleEditMode()" *ngIf="!isEditMode">
              <i class="fas fa-camera"></i>
            </div>
          </div>
          <div class="owner-primary-info">
            <h2 class="owner-display-name">{{ profile.owner_name || 'Set Your Name' }}</h2>
            <p class="owner-location-tag">
              <i class="fas fa-map-marker-alt"></i> {{ profile.owner_city }}, {{ profile.owner_state }}
            </p>
          </div>
        </div>

        <div class="luxury-divider">
          <span><i class="fas fa-id-card"></i> Contact Details</span>
        </div>

        <div class="owner-details-grid">
          <div class="detail-item">
            <div class="detail-icon"><i class="fas fa-home"></i></div>
            <div class="detail-content">
              <label>Address</label>
              <p>{{ profile.owner_address || 'No address added' }}</p>
            </div>
          </div>
          <div class="detail-item">
            <div class="detail-icon"><i class="fas fa-phone-alt"></i></div>
            <div class="detail-content">
              <label>Phone Number</label>
              <p>{{ profile.owner_phone || 'No phone added' }}</p>
            </div>
          </div>
        </div>

        <div class="owner-actions">
          <button class="btn-premium gold" (click)="toggleEditMode()" *ngIf="!isEditMode">
            <i class="fas fa-edit"></i> Edit Profile
          </button>
        </div>
      </div>
    </section>

    <!-- Pets Tab -->
    <section class="tab-section" *ngIf="activeTab === 'pets'" [@tabAnimation]>
      <!-- Pets Toolbar -->
      <div class="pets-toolbar">
        <div class="toolbar-left">
          <div class="filter-pill">
            <button [class.active]="activePetFilter === 'all'" (click)="showAllPets()">All</button>
            <button [class.active]="activePetFilter === 'dogs'" (click)="showOnlyDogs()">Dogs</button>
            <button [class.active]="activePetFilter === 'cats'" (click)="showOnlyCats()">Cats</button>
            <button [class.active]="activePetFilter === 'other'" (click)="showOtherPets()">Other</button>
          </div>
        </div>
        <div class="toolbar-right">
          <button class="btn-premium dark" (click)="startAddPet()">
            <i class="fas fa-plus"></i> Add New Pet
          </button>
        </div>
      </div>

      <!-- Pets Grid -->
      <div class="pets-grid" *ngIf="!loadingPets; else loadingSkel">
        <div class="pet-premium-card luxury-card" *ngFor="let pet of pets">
          <div class="pet-photo-container">
            <img [src]="getPetPhotoUrl(pet)" [alt]="pet.pet_name" class="pet-card-img">
            <div class="pet-type-badge">{{ pet.species }}</div>
          </div>

          <div class="pet-card-content">
            <div class="pet-card-header">
              <h3 class="pet-name">{{ pet.pet_name }}</h3>
              <div class="lost-toggle-wrapper">
                <span class="lost-label" [class.is-lost]="pet.is_lost">
                  {{ pet.is_lost ? 'Lost' : 'Safe' }}
                </span>
                <label class="switch">
                  <input type="checkbox" [checked]="pet.is_lost" (change)="markAsLost(pet, $event)">
                  <span class="slider round"></span>
                </label>
              </div>
            </div>

            <p class="pet-breed-text"><i class="fas fa-dna"></i> {{ pet.breed || 'Mixed Breed' }}</p>
            <div class="pet-meta-info">
              <span><i class="fas fa-birthday-cake"></i> {{ pet.age }} Years</span>
            </div>

            <div class="pet-card-actions">
              <button class="action-btn preview" (click)="openPreviewModal(pet, $event)" title="Preview">
                <i class="fas fa-eye"></i>
                <span class="btn-label">View</span>
              </button>
              <button class="action-btn alert" (click)="openAlertModal(pet, $event)" title="Alerts">
                <i class="fas fa-bell"></i>
                <span class="btn-label">Alerts</span>
                <span class="alert-count" *ngIf="pet.alerts && pet.alerts.length > 0">{{ pet.alerts.length }}</span>
              </button>
              <button class="action-btn edit" (click)="editPet(pet, $event)" title="Edit">
                <i class="fas fa-pen"></i>
                <span class="btn-label">Edit</span>
              </button>
              <button class="action-btn delete" (click)="deletePet(pet, $event)" title="Delete">
                <i class="fas fa-trash-alt"></i>
                <span class="btn-label">Remove</span>
              </button>
              <a [routerLink]="['/pet-public']" [queryParams]="{user_id: userId, pet_id: pet.pet_id}"
                class="action-btn public-link" title="Public Profile" (click)="$event.stopPropagation()">
                <i class="fas fa-external-link-alt"></i>
                <span class="btn-label">Public Profile</span>
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-pets" *ngIf="!loadingPets && pets.length === 0">
        <div class="empty-icon"><i class="fas fa-paw"></i></div>
        <h3>No pets found</h3>
        <p>Your pet family is waiting to be built. Add your first companion!</p>
        <button class="btn-premium gold" (click)="startAddPet()">Add Your First Pet</button>
      </div>
    </section>
  </main>

  <!-- Edit Owner Profile Modal -->
  <div class="modal-root glass-effect" *ngIf="isEditMode" [@modalFade]>
    <div class="modal-container luxury-card">
      <div class="modal-header">
        <h3>{{ hasProfile ? 'Refine Profile' : 'Complete Profile' }}</h3>
        <button class="close-btn" (click)="toggleEditMode()"><i class="fas fa-times"></i></button>
      </div>
      <form (ngSubmit)="onSubmit()" #profileForm="ngForm" class="luxury-form">
        <div class="form-grid">
          <div class="form-group full">
            <label>Profile Photo</label>
            <div class="photo-uploader">
              <div class="uploader-preview">
                <img [src]="ownerPhotoPreview || 'assets/icons/avatar.svg'" class="preview-img">
              </div>
              <div class="uploader-actions">
                <label class="btn-upload">
                  <input type="file" (change)="onOwnerPhotoSelected($event)" hidden>
                  <i class="fas fa-cloud-upload-alt"></i> Choose Photo
                </label>
                <button type="button" class="btn-remove" (click)="removeOwnerPhoto()"
                  *ngIf="ownerPhotoPreview">Remove</button>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>Display Name</label>
            <input type="text" name="owner_name" [(ngModel)]="profile.owner_name" required placeholder="Full Name"
              class="luxury-input">
          </div>
          <div class="form-group">
            <label>City</label>
            <input type="text" name="owner_city" [(ngModel)]="profile.owner_city" required placeholder="Current City"
              class="luxury-input">
          </div>
          <div class="form-group">
            <label>State</label>
            <input type="text" name="owner_state" [(ngModel)]="profile.owner_state" required placeholder="State"
              class="luxury-input">
          </div>
          <div class="form-group">
            <label>Phone Number</label>
            <input type="tel" name="owner_phone" [(ngModel)]="profile.owner_phone" placeholder="+91 ..."
              class="luxury-input">
          </div>
          <div class="form-group full">
            <label>Residential Address</label>
            <textarea name="owner_address" [(ngModel)]="profile.owner_address" rows="2"
              placeholder="Street, Building, etc." class="luxury-input"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" (click)="toggleEditMode()">Cancel</button>
          <button type="submit" class="btn-premium gold" [disabled]="profileForm.invalid || isLoading">
            {{ isLoading ? 'Saving...' : 'Save Profile' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Pet Form Modal -->
  <div class="modal-root glass-effect" *ngIf="isPetFormVisible" [@modalFade]>
    <div class="modal-container luxury-card">
      <div class="modal-header">
        <h3>{{ editingPet ? 'Modify Pet' : 'Register New Pet' }}</h3>
        <button class="close-btn" (click)="cancelPetForm()"><i class="fas fa-times"></i></button>
      </div>
      <form (ngSubmit)="savePet()" #petForm="ngForm" class="luxury-form">
        <div class="form-grid">
          <div class="form-group full">
            <label>Pet Image</label>
            <div class="photo-uploader">
              <div class="uploader-preview">
                <img [src]="petPhotoPreview || getPetPhotoUrl(currentPet)" class="preview-img">
              </div>
              <div class="uploader-actions">
                <label class="btn-upload">
                  <input type="file" (change)="onPetPhotoSelected($event)" hidden>
                  <i class="fas fa-camera"></i> Change Image
                </label>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>Pet Name</label>
            <input type="text" name="pet_name" [(ngModel)]="currentPet.pet_name" required class="luxury-input">
          </div>
          <div class="form-group">
            <label>Species</label>
            <select name="species" [(ngModel)]="currentPet.species" required class="luxury-select">
              <option value="Dog">Dog</option>
              <option value="Cat">Cat</option>
              <option value="Bird">Bird</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Breed</label>
            <input type="text" name="breed" [(ngModel)]="currentPet.breed" class="luxury-input">
          </div>
          <div class="form-group">
            <label>Age (Years)</label>
            <input type="number" name="age" [(ngModel)]="currentPet.age" class="luxury-input">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" (click)="cancelPetForm()">Cancel</button>
          <button type="submit" class="btn-premium dark" [disabled]="petForm.invalid || loadingPets">
            {{ loadingPets ? 'Syncing...' : (editingPet ? 'Update Pet' : 'Register Pet') }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Pet Preview Modal -->
  <div class="modal-root glass-effect" *ngIf="isPreviewModalOpen" [@modalFade]>
    <div class="modal-container luxury-card preview-modal">
      <div class="preview-hero">
        <img [src]="getPetPhotoUrl(selectedPet!)" class="preview-hero-img">
        <button class="close-btn floating" (click)="closePreviewModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="preview-body">
        <div class="preview-header">
          <h2 class="pet-title">{{ selectedPet?.pet_name }}</h2>
          <span class="status-chip" [class.lost]="selectedPet?.is_lost">
            {{ selectedPet?.is_lost ? 'Reported Lost' : 'At Home' }}
          </span>
        </div>
        <div class="preview-info-grid">
          <div class="info-block">
            <label>Species</label>
            <p>{{ selectedPet?.species }}</p>
          </div>
          <div class="info-block">
            <label>Breed</label>
            <p>{{ selectedPet?.breed || 'Not specified' }}</p>
          </div>
          <div class="info-block">
            <label>Age</label>
            <p>{{ selectedPet?.age }} Years</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alerts Modal -->
  <div class="modal-root glass-effect" *ngIf="isAlertModalOpen" [@modalFade]>
    <div class="modal-container luxury-card alerts-modal">
      <div class="modal-header">
        <h3>Recent Alerts: {{ selectedPet?.pet_name }}</h3>
        <button class="close-btn" (click)="closeAlertModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="alerts-viewport">
        <div *ngIf="selectedPet?.alerts?.length === 0" class="empty-alerts">
          <i class="fas fa-check-circle"></i>
          <p>No active alerts for this pet.</p>
        </div>
        <div class="alert-premium-item" *ngFor="let alert of selectedPet?.alerts" [class.resolved]="alert.resolved">
          <div class="alert-top">
            <div class="sender-info">
              <strong>{{ alert.sender_name }}</strong>
              <span>{{ alert.created_at | date:'medium' }}</span>
            </div>
            <button class="btn-resolve" (click)="resolveAlert(alert.id)" *ngIf="!alert.resolved">
              MARK RESOLVED
            </button>
          </div>
          <div class="alert-main">
            <p class="alert-msg">"{{ alert.message }}"</p>
            <div class="alert-meta">
              <p><i class="fas fa-phone-alt"></i> {{ alert.phone }}</p>
              <p><i class="fas fa-map-marker-alt"></i> {{ formatLocation(alert.location) }}</p>
            </div>
          </div>
          <div class="alert-actions">
            <button class="btn-action-map" (click)="viewOnMap(formatLocation(alert.location))">
              <i class="fas fa-map-marked-alt"></i> View on Map
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template #loadingSkel>
    <div class="loading-grid">
      <div class="skeleton-card" *ngFor="let i of [1,2,3,4]"></div>
    </div>
  </ng-template>